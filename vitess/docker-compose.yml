services:
  etcd1:
    image: gcr.io/etcd-development/etcd:v3.5.11
    hostname: etcd1
    environment:
      - ETCD_NAME=etcd1
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd1:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd1:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster
    ports:
      - 2379:2379
      - 2380:2380
    networks:
      - shared

  etcd2:
    image: gcr.io/etcd-development/etcd:v3.5.11
    hostname: etcd2
    depends_on:
      - etcd1
    environment:
      - ETCD_NAME=etcd2
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd2:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd2:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster
    expose:
      - "2379"
      - "2380"
    networks:
      - shared

  etcd3:
    image: gcr.io/etcd-development/etcd:v3.5.11
    hostname: etcd3
    depends_on:
      - etcd1
    environment:
      - ETCD_NAME=etcd3
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd3:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd3:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_INITIAL_CLUSTER=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster
    expose:
      - "2379"
      - "2380"
    networks:
      - shared

  schemaload_lookup_keyspace:
    command:
      - sh
      - -c
      - /script/schemaload.sh
    depends_on:
      vttablet301:
        condition: service_healthy
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - GRPC_PORT=15999
      - CELL=test
      - KEYSPACE=lookup_keyspace
      - TARGETTAB=test-0000000301
      - SLEEPTIME=15
      - VSCHEMA_FILE=lookup_keyspace_vschema.json
      - SCHEMA_FILES=lookup_keyspace_schema_file.sql
      - POST_LOAD_FILE=
      - EXTERNAL_DB=1
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=root
      - DB_PORT=3306
    image: vitess/lite:${VITESS_TAG:-latest}
    volumes:
      - ./compose:/script
    networks:
      - shared

  schemaload_test_keyspace:
    command:
      - sh
      - -c
      - /script/schemaload.sh
    depends_on:
      vttablet101:
        condition: service_healthy
      vttablet201:
        condition: service_healthy
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - GRPC_PORT=15999
      - CELL=test
      - KEYSPACE=test_keyspace
      - TARGETTAB=test-0000000101
      - SLEEPTIME=15
      - VSCHEMA_FILE=test_keyspace_vschema.json
      - SCHEMA_FILES=test_keyspace_schema_file.sql
      - POST_LOAD_FILE=
      - EXTERNAL_DB=1
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=root
      - DB_PORT=3306
    image: vitess/lite:${VITESS_TAG:-latest}
    volumes:
      - ./compose:/script
    networks:
      - shared

  set_keyspace_durability_policy:
    command:
      - sh
      - -c
      - /script/set_keyspace_durability_policy.sh
    depends_on:
      - vttablet101
      - vttablet301
    environment:
      - KEYSPACES=test_keyspace lookup_keyspace
      - GRPC_PORT=15999
    image: vitess/lite:${VITESS_TAG:-latest}
    volumes:
      - ./compose:/script
    networks:
      - shared

  vreplication:
    command:
      - sh
      - -c
      - "[ $$EXTERNAL_DB -eq 1 ] && /script/externaldb_vreplication.sh || exit 0"
    depends_on:
      - vtctld
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global
      - EXTERNAL_DB=1
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=root
      - DB_PORT=3306
    image: vitess/lite:${VITESS_TAG:-latest}
    volumes:
      - ./compose:/script
    networks:
      - shared

  vtctld:
    command:
      - sh
      - -c
      - " /vt/bin/vtctld --topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global --cell test
        --service-map 'grpc-vtctl,grpc-vtctld' --backup-storage-implementation file --file-backup-storage-root
        /vt/vtdataroot/backups --logtostderr=true --port 8080 --grpc-port 15999 "
    image: vitess/lite:${VITESS_TAG:-latest}
    ports:
      - 15000:8080
      - "15999"
    volumes:
      - ./compose:/script
    networks:
      - shared

  vtgate:
    command:
      - sh
      - -c
      - "/script/run-forever.sh /vt/bin/vtgate --topo-implementation etcd2 --topo-global-server-address
        etcd1:2379 --topo-global-root vitess/global --logtostderr=true --port 8080 --grpc-port
        15999 --mysql-server-port 15306 --mysql-auth-server-impl none --cell test --cells-to-watch
        test --tablet-types-to-wait PRIMARY,REPLICA,RDONLY --service-map 'grpc-vtgateservice'
        --normalize-queries=true "
    depends_on:
      - vtctld
    image: vitess/lite:${VITESS_TAG:-latest}
    ports:
      - 15099:8080
      - "15999"
      - 15306:15306
    volumes:
      - ./compose:/script
    networks:
      - shared

  vtorc:
    command:
      - sh
      - -c
      - /script/vtorc-up.sh
    depends_on:
      - vtctld
      - set_keyspace_durability_policy
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - EXTERNAL_DB=1
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=root
      - DB_PORT=3306
    image: vitess/lite:${VITESS_TAG:-latest}
    ports:
      - 13000:8080
    volumes:
      - ./compose:/script
    networks:
      - shared

  vttablet101:
    command:
      - sh
      - -c
      - /script/vttablet-up.sh 101
    depends_on:
      - vtctld
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - GRPC_PORT=15999
      - CELL=test
      - KEYSPACE=test_keyspace
      - SHARD=-80
      - ROLE=primary
      - VTHOST=vttablet101
      - EXTERNAL_DB=1
      - DB_PORT=3306
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=root
      - DB_CHARSET=
    healthcheck:
      interval: 30s
      retries: 15
      test:
        - CMD-SHELL
        - curl -s --fail --show-error localhost:8080/debug/health
      timeout: 10s
    image: vitess/lite:${VITESS_TAG:-latest}
    ports:
      - 15101:8080
      - "15999"
      - "3306"
    volumes:
      - ./compose:/script
    networks:
      - shared

  vttablet102:
    command:
      - sh
      - -c
      - /script/vttablet-up.sh 102
    depends_on:
      - vtctld
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - GRPC_PORT=15999
      - CELL=test
      - KEYSPACE=test_keyspace
      - SHARD=-80
      - ROLE=replica
      - VTHOST=vttablet102
      - EXTERNAL_DB=1
      - DB_PORT=3306
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=root
      - DB_CHARSET=
    healthcheck:
      interval: 30s
      retries: 15
      test:
        - CMD-SHELL
        - curl -s --fail --show-error localhost:8080/debug/health
      timeout: 10s
    image: vitess/lite:${VITESS_TAG:-latest}
    ports:
      - 15102:8080
      - "15999"
      - "3306"
    volumes:
      - ./compose:/script
    networks:
      - shared

  vttablet201:
    command:
      - sh
      - -c
      - /script/vttablet-up.sh 201
    depends_on:
      - vtctld
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - GRPC_PORT=15999
      - CELL=test
      - KEYSPACE=test_keyspace
      - SHARD=80-
      - ROLE=primary
      - VTHOST=vttablet201
      - EXTERNAL_DB=1
      - DB_PORT=3306
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=root
      - DB_CHARSET=
    healthcheck:
      interval: 30s
      retries: 15
      test:
        - CMD-SHELL
        - curl -s --fail --show-error localhost:8080/debug/health
      timeout: 10s
    image: vitess/lite:${VITESS_TAG:-latest}
    ports:
      - 15201:8080
      - "15999"
      - "3306"
    volumes:
      - ./compose:/script
    networks:
      - shared

  vttablet202:
    command:
      - sh
      - -c
      - /script/vttablet-up.sh 202
    depends_on:
      - vtctld
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - GRPC_PORT=15999
      - CELL=test
      - KEYSPACE=test_keyspace
      - SHARD=80-
      - ROLE=replica
      - VTHOST=vttablet202
      - EXTERNAL_DB=1
      - DB_PORT=3306
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=root
      - DB_CHARSET=
    healthcheck:
      interval: 30s
      retries: 15
      test:
        - CMD-SHELL
        - curl -s --fail --show-error localhost:8080/debug/health
      timeout: 10s
    image: vitess/lite:${VITESS_TAG:-latest}
    ports:
      - 15202:8080
      - "15999"
      - "3306"
    volumes:
      - ./compose:/script
    networks:
      - shared

  vttablet301:
    command:
      - sh
      - -c
      - /script/vttablet-up.sh 301
    depends_on:
      - vtctld
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - GRPC_PORT=15999
      - CELL=test
      - KEYSPACE=lookup_keyspace
      - SHARD=-
      - ROLE=primary
      - VTHOST=vttablet301
      - EXTERNAL_DB=1
      - DB_PORT=3306
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=root
      - DB_CHARSET=
    healthcheck:
      interval: 30s
      retries: 15
      test:
        - CMD-SHELL
        - curl -s --fail --show-error localhost:8080/debug/health
      timeout: 10s
    image: vitess/lite:${VITESS_TAG:-latest}
    ports:
      - 15301:8080
      - "15999"
      - "3306"
    volumes:
      - ./compose:/script
    networks:
      - shared

  vttablet302:
    command:
      - sh
      - -c
      - /script/vttablet-up.sh 302
    depends_on:
      - vtctld
    environment:
      - TOPOLOGY_FLAGS=--topo-implementation etcd2 --topo-global-server-address etcd1:2379
        --topo-global-root vitess/global
      - WEB_PORT=8080
      - GRPC_PORT=15999
      - CELL=test
      - KEYSPACE=lookup_keyspace
      - SHARD=-
      - ROLE=replica
      - VTHOST=vttablet302
      - EXTERNAL_DB=1
      - DB_PORT=3306
      - DB_HOST=mysql
      - DB_USER=root
      - DB_PASS=root
      - DB_CHARSET=
    healthcheck:
      interval: 30s
      retries: 15
      test:
        - CMD-SHELL
        - curl -s --fail --show-error localhost:8080/debug/health
      timeout: 10s
    image: vitess/lite:${VITESS_TAG:-latest}
    ports:
      - 15302:8080
      - "15999"
      - "3306"
    volumes:
      - ./compose:/script
    networks:
      - shared

networks:
  shared:
    external: true
